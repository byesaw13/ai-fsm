# AI Changelog

Each AI run must append one record. Keep entries factual and short.

## Entry Template
- Timestamp (UTC):
- Agent:
- Branch:
- Task ID:
- Summary:
- Files changed:
- Commands run:
- Gate results: lint/typecheck/build/test
- Risks or follow-ups:

---

- Timestamp (UTC): 2026-02-16T00:00:00Z
- Agent: codex
- Branch: local-uncommitted
- Task ID: scaffold-init
- Summary: Created full AI-first scaffold with web, worker, domain, migrations, infra, and autonomous docs.
- Files changed:
  - README.md
  - AGENTS.md
  - apps/web/*
  - services/worker/*
  - packages/domain/*
  - db/migrations/*
  - infra/*
  - scripts/*
  - docs/*
- Commands run:
  - mkdir/cat/chmod/bash -n/json parse checks
- Gate results: lint/typecheck/build/test not run yet (dependencies not installed)
- Risks or follow-ups:
  - Need first dependency install and initial gate baseline.

- Timestamp (UTC): 2026-02-16T17:45:00Z
- Agent: codex
- Branch: orchestrator/start-process-wave1
- Task ID: process-kickoff-wave1
- Summary: Started autonomous process by creating labeled GitHub task queue, wave-1 kickoff docs, and active claim assignments for P0 contract freeze.
- Files changed:
  - docs/START_PROCESS_NOW.md
  - docs/AGENT_LAUNCH_PACK.md
  - docs/WORK_ASSIGNMENT.md
- Commands run:
  - gh label create/edit
  - gh issue create/list
- Gate results: lint/typecheck/build/test not run (docs/process change only)
- Risks or follow-ups:
  - Branch protection active; merge requires PR approval.
  - Agents should claim #7/#8/#9 immediately.

- Timestamp (UTC): 2026-02-16T20:00:00Z
- Agent: agent-orchestrator (Claude Code)
- Branch: orchestrator/start-process-wave1
- Task ID: P0-T1, P0-T2, P0-T3 (#7, #8, #9)
- Summary: Froze all three P0 contracts with full source evidence from dovelite and myprogram. Updated domain Zod schemas to cover all entities (account, user, client, property, job, visit, estimate, invoice, payment, automation, audit_log) with status transition maps. Updated core migration to match frozen contract (added properties, estimate_line_items, invoice_line_items, audit_log tables; added updated_at triggers, created_by FKs, and comprehensive indexes). Updated seed data with deterministic UUIDs and two test accounts for RLS abuse testing.
- Files changed:
  - docs/contracts/domain-model.md (frozen — full entity specs, relationships, immutability rules)
  - docs/contracts/workflow-states.md (frozen — transition tables, role matrix, automation types)
  - docs/contracts/api-contract.md (frozen — all endpoints, error model, pagination, auth)
  - docs/contracts/test-strategy.md (frozen — tooling, categories, RLS abuse tests, phase rollout)
  - packages/domain/src/index.ts (full Zod schemas for all entities + transition maps + API error model)
  - db/migrations/001_core_schema.sql (complete schema matching frozen contract)
  - db/migrations/002_seed_dev.sql (two accounts, four users with deterministic UUIDs)
  - docs/WORK_ASSIGNMENT.md (P0 claims resolved)
  - CLAUDE.md (created for Claude Code onboarding)
- Commands run:
  - pnpm install
  - pnpm gate (lint ✅ typecheck ✅ build ✅ test ✅)
- Gate results: lint ✅ | typecheck ✅ | build ✅ | test ✅ (placeholder)
- Source evidence:
  - Dovelite: db/001_initial_schema.sql (visit schema), db/002_rls_policies.sql (RLS pattern), tests/fixtures.ts (deterministic UUIDs), playwright.config.ts (E2E config)
  - Myprogram: DOMAIN_MODEL.md (entity structure), RLS_POLICY_MATRIX.md (RBAC matrix), supabase/migrations/001-003 (schema, RLS, workflow invariants), EDGE_FUNCTIONS.md (API patterns)
- Risks or follow-ups:
  - Tests are still placeholders — real test infrastructure needed in P1.
  - Migration not yet applied to a real database — validate in P1-T2.
  - P0 complete — P1 tasks (auth, schema+RLS, audit, CI/CD) are now unblocked.

- Timestamp (UTC): 2026-02-17T00:00:00Z
- Agent: agent-b (DB+RLS Specialist)
- Branch: agent-b/P1-T2-rls-migrations
- Task ID: P1-T2
- Summary: Implemented full RLS policy suite (003_rls_policies.sql) and workflow invariant triggers (004_workflow_invariants.sql). RLS uses PostgreSQL session variables (app.current_user_id, app.current_account_id, app.current_role) set by the app layer. All 13 tables have RLS enabled with force_rls. Role matrix enforced at DB layer: owner/admin write access, tech read-only on estimates/invoices, tech update own-assigned visits only. Workflow guards enforce valid state transitions for jobs/visits/estimates/invoices; immutability triggers block field edits in non-editable states; payment INSERT trigger auto-syncs invoice paid_cents and status.
- Files changed:
  - db/migrations/003_rls_policies.sql (RLS helper functions, enable+force RLS, all policies)
  - db/migrations/004_workflow_invariants.sql (job/visit/estimate/invoice transition guards, immutability triggers, payment→invoice sync trigger)
  - docs/WORK_ASSIGNMENT.md (P1-T2 claim)
- Commands run:
  - rm -rf apps/web/.next && pnpm gate
- Gate results: lint ✅ | typecheck ✅ | build ✅ | test ✅
- Source evidence:
  - Myprogram: supabase/migrations/002_rls_policies.sql (RBAC policy structure, account-scoped helper functions, security definer pattern), supabase/migrations/003_workflow_invariants.sql (transition validation functions, immutability trigger pattern)
  - Dovelite: db/002_rls_policies.sql (account-scoped RLS helper pattern, enable_rls + force_rls), db/001_initial_schema.sql (arrived_at/completed_at auto-set pattern)
- Risks or follow-ups:
  - sync_invoice_on_payment uses security definer — must validate RLS pass-through in integration tests (P1-T3/P3).
  - Migrations not yet applied to live DB — validate against real PostgreSQL in next infra task.
  - P1-T2 complete pending merge after P1-T1 lands on main first (per orchestrator directive).
  - P1-T3 (audit log) remains blocked until P1-T1 + P1-T2 are both merged.

## [P4-T2] Overdue Invoice Follow-Up Automation — agent-d — 2026-02-18
- Issue: #21
- Branch: agent-d/P4-T2-overdue-invoice-followups
- Summary: Implemented overdue invoice follow-up automation with configurable cadence thresholds, idempotent event emission, and per-record error isolation.
- Files changed:
  - services/worker/src/invoice-followup.ts (new — core follow-up logic)
  - services/worker/src/invoice-followup.test.ts (new — 24 unit tests)
  - services/worker/src/invoice-followup.integration.test.ts (new — 8 integration tests, skip without DB)
  - services/worker/src/index.ts (modified — dispatch follow-ups in poll loop)
  - tests/e2e/invoice-followup-smoke.spec.ts (new — 2 E2E smoke tests)
  - docs/WORK_ASSIGNMENT.md (modified — P4-T2 claim)
- Commands run:
  - git checkout -b agent-d/P4-T2-overdue-invoice-followups
  - pnpm lint ✓
  - pnpm typecheck ✓
  - pnpm build ✓
  - pnpm test ✓ (107 tests pass, 8 skipped — integration requires DB)
- Gate results: lint ✓ / typecheck ✓ / build ✓ / test ✓ (107 pass, 8 skipped)
- Idempotency proof:
  - `emitInvoiceFollowup` checks audit_log for existing entry matching entity_id + days_overdue_step before INSERT
  - Unit test: "returns false and skips insert if follow-up already exists for cadence step"
  - Integration test: "repeated runs don't duplicate follow-ups"
- Retry-safety proof:
  - Each invoice processed independently in try/catch — one failure doesn't block others
  - Each cadence step processed independently — one failure doesn't block others
  - Each automation processed independently — one failure doesn't block others
  - Unit tests: "continues processing after individual invoice errors", "continues after a failed automation"
  - `markAutomationRun` always called (even with 0 overdue invoices) to advance next_run_at
- Source evidence:
  - AI-FSM: docs/contracts/workflow-states.md — invoice_followup automation type, invoice lifecycle (overdue status)
  - AI-FSM: db/migrations/001_core_schema.sql — invoices.due_date, automations.config jsonb
  - AI-FSM: services/worker/src/visit-reminder.ts (P4-T1 branch) — reliability pattern reference
  - Myprogram: EDGE_FUNCTIONS_RUNBOOK.md — idempotent worker pattern
  - Dovelite: scripts/preflight.mjs — safe retry/check-before-act pattern
- Risks or follow-ups:
  - Integration tests need TEST_DATABASE_URL (skipped without it, 8 skipped)
  - E2E tests need running dev server + seeded data
  - Default cadence [7, 14, 30] days — configurable per automation via config.days_overdue
  - Includes sent/partial invoices past due_date (not just status='overdue') for broader coverage
  - P4-T1 (visit reminders) must merge first; this branch is independent but worker index.ts will need reconciliation
