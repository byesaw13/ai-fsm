# AI Changelog

Each AI run must append one record. Keep entries factual and short.

## Entry Template
- Timestamp (UTC):
- Agent:
- Branch:
- Task ID:
- Summary:
- Files changed:
- Commands run:
- Gate results: lint/typecheck/build/test
- Risks or follow-ups:

---

- Timestamp (UTC): 2026-02-16T00:00:00Z
- Agent: codex
- Branch: local-uncommitted
- Task ID: scaffold-init
- Summary: Created full AI-first scaffold with web, worker, domain, migrations, infra, and autonomous docs.
- Files changed:
  - README.md
  - AGENTS.md
  - apps/web/*
  - services/worker/*
  - packages/domain/*
  - db/migrations/*
  - infra/*
  - scripts/*
  - docs/*
- Commands run:
  - mkdir/cat/chmod/bash -n/json parse checks
- Gate results: lint/typecheck/build/test not run yet (dependencies not installed)
- Risks or follow-ups:
  - Need first dependency install and initial gate baseline.

- Timestamp (UTC): 2026-02-16T17:45:00Z
- Agent: codex
- Branch: orchestrator/start-process-wave1
- Task ID: process-kickoff-wave1
- Summary: Started autonomous process by creating labeled GitHub task queue, wave-1 kickoff docs, and active claim assignments for P0 contract freeze.
- Files changed:
  - docs/START_PROCESS_NOW.md
  - docs/AGENT_LAUNCH_PACK.md
  - docs/WORK_ASSIGNMENT.md
- Commands run:
  - gh label create/edit
  - gh issue create/list
- Gate results: lint/typecheck/build/test not run (docs/process change only)
- Risks or follow-ups:
  - Branch protection active; merge requires PR approval.
  - Agents should claim #7/#8/#9 immediately.

- Timestamp (UTC): 2026-02-16T20:00:00Z
- Agent: agent-orchestrator (Claude Code)
- Branch: orchestrator/start-process-wave1
- Task ID: P0-T1, P0-T2, P0-T3 (#7, #8, #9)
- Summary: Froze all three P0 contracts with full source evidence from dovelite and myprogram. Updated domain Zod schemas to cover all entities (account, user, client, property, job, visit, estimate, invoice, payment, automation, audit_log) with status transition maps. Updated core migration to match frozen contract (added properties, estimate_line_items, invoice_line_items, audit_log tables; added updated_at triggers, created_by FKs, and comprehensive indexes). Updated seed data with deterministic UUIDs and two test accounts for RLS abuse testing.
- Files changed:
  - docs/contracts/domain-model.md (frozen — full entity specs, relationships, immutability rules)
  - docs/contracts/workflow-states.md (frozen — transition tables, role matrix, automation types)
  - docs/contracts/api-contract.md (frozen — all endpoints, error model, pagination, auth)
  - docs/contracts/test-strategy.md (frozen — tooling, categories, RLS abuse tests, phase rollout)
  - packages/domain/src/index.ts (full Zod schemas for all entities + transition maps + API error model)
  - db/migrations/001_core_schema.sql (complete schema matching frozen contract)
  - db/migrations/002_seed_dev.sql (two accounts, four users with deterministic UUIDs)
  - docs/WORK_ASSIGNMENT.md (P0 claims resolved)
  - CLAUDE.md (created for Claude Code onboarding)
- Commands run:
  - pnpm install
  - pnpm gate (lint ✅ typecheck ✅ build ✅ test ✅)
- Gate results: lint ✅ | typecheck ✅ | build ✅ | test ✅ (placeholder)
- Source evidence:
  - Dovelite: db/001_initial_schema.sql (visit schema), db/002_rls_policies.sql (RLS pattern), tests/fixtures.ts (deterministic UUIDs), playwright.config.ts (E2E config)
  - Myprogram: DOMAIN_MODEL.md (entity structure), RLS_POLICY_MATRIX.md (RBAC matrix), supabase/migrations/001-003 (schema, RLS, workflow invariants), EDGE_FUNCTIONS.md (API patterns)
- Risks or follow-ups:
  - Tests are still placeholders — real test infrastructure needed in P1.
  - Migration not yet applied to a real database — validate in P1-T2.
  - P0 complete — P1 tasks (auth, schema+RLS, audit, CI/CD) are now unblocked.

- Timestamp (UTC): 2026-02-17T00:00:00Z
- Agent: agent-b (DB+RLS Specialist)
- Branch: agent-b/P1-T2-rls-migrations
- Task ID: P1-T2
- Summary: Implemented full RLS policy suite (003_rls_policies.sql) and workflow invariant triggers (004_workflow_invariants.sql). RLS uses PostgreSQL session variables (app.current_user_id, app.current_account_id, app.current_role) set by the app layer. All 13 tables have RLS enabled with force_rls. Role matrix enforced at DB layer: owner/admin write access, tech read-only on estimates/invoices, tech update own-assigned visits only. Workflow guards enforce valid state transitions for jobs/visits/estimates/invoices; immutability triggers block field edits in non-editable states; payment INSERT trigger auto-syncs invoice paid_cents and status.
- Files changed:
  - db/migrations/003_rls_policies.sql (RLS helper functions, enable+force RLS, all policies)
  - db/migrations/004_workflow_invariants.sql (job/visit/estimate/invoice transition guards, immutability triggers, payment→invoice sync trigger)
  - docs/WORK_ASSIGNMENT.md (P1-T2 claim)
- Commands run:
  - rm -rf apps/web/.next && pnpm gate
- Gate results: lint ✅ | typecheck ✅ | build ✅ | test ✅
- Source evidence:
  - Myprogram: supabase/migrations/002_rls_policies.sql (RBAC policy structure, account-scoped helper functions, security definer pattern), supabase/migrations/003_workflow_invariants.sql (transition validation functions, immutability trigger pattern)
  - Dovelite: db/002_rls_policies.sql (account-scoped RLS helper pattern, enable_rls + force_rls), db/001_initial_schema.sql (arrived_at/completed_at auto-set pattern)
- Risks or follow-ups:
  - sync_invoice_on_payment uses security definer — must validate RLS pass-through in integration tests (P1-T3/P3).
  - Migrations not yet applied to live DB — validate against real PostgreSQL in next infra task.
  - P1-T2 complete pending merge after P1-T1 lands on main first (per orchestrator directive).
  - P1-T3 (audit log) remains blocked until P1-T1 + P1-T2 are both merged.

---

- Timestamp (UTC): 2026-02-17T22:00:00Z
- Agent: agent-c (Frontend+QA Specialist)
- Branch: agent-c/P2-T3-role-based-admin-tech-views
- Task ID: P2-T3 / Issue #16
- Summary: Implemented role-based admin and tech UI views for jobs and visits. Admin sees all jobs/visits with status transition controls and visit scheduling; tech sees only assigned jobs/visits with notes form and allowed status transitions. Role-aware nav hides finance/automations links from tech. All forbidden actions hidden client-side; API enforces hard RBAC. Added 7 new permission helpers. Added 32 new Vitest unit tests (all passing). Added Playwright E2E smoke specs for admin and tech roles.
- Files changed:
  - apps/web/lib/auth/permissions.ts (added: canCreateVisit, canAssignVisit, canTransitionJob, canTransitionVisit, canUpdateVisitNotes, canViewAllJobs, canViewAllVisits)
  - apps/web/app/app/layout.tsx (role-aware nav: hides estimates/invoices/automations from tech; role badge)
  - apps/web/app/app/jobs/page.tsx (jobs list: admin sees all, tech sees assigned-only via JOIN on visits)
  - apps/web/app/app/jobs/[id]/page.tsx (job detail: transition panel admin-only, visit list role-scoped)
  - apps/web/app/app/jobs/[id]/JobTransitionForm.tsx (client component: job status transition via API)
  - apps/web/app/app/jobs/new/page.tsx (stub: role-guarded, links to P2-T1 form)
  - apps/web/app/app/jobs/[id]/visits/new/page.tsx (stub: role-guarded, links to P2-T2 form)
  - apps/web/app/app/visits/page.tsx (visits list: admin sees all+unassigned badge, tech assigned-only)
  - apps/web/app/app/visits/[id]/page.tsx (visit detail: transition panel all roles, notes form all roles, assignment info)
  - apps/web/app/app/visits/[id]/VisitTransitionForm.tsx (client component: visit status transition via API)
  - apps/web/app/app/visits/[id]/VisitNotesForm.tsx (client component: PATCH tech_notes via API)
  - apps/web/app/globals.css (nav, role badges, status pills, card/button/form styles)
  - apps/web/lib/auth/__tests__/role-views.unit.test.ts (32 unit tests for new permissions)
  - tests/e2e/admin-smoke.spec.ts (Playwright E2E: admin role smoke path)
  - tests/e2e/tech-smoke.spec.ts (Playwright E2E: tech role smoke path)
  - docs/WORK_ASSIGNMENT.md (claim registered)
- Commands run:
  - pnpm lint ✅
  - pnpm typecheck ✅
  - pnpm build ✅
  - pnpm test ✅ (73 unit tests: 4 files, all pass — 32 new in role-views.unit.test.ts)
- Gate results: lint ✅ | typecheck ✅ | build ✅ | test ✅ (73 tests)
- Source evidence:
  - Dovelite: app/admin/visits/page.tsx — grouped-by-status pattern, scheduled/in-progress/completed sections, client name display, unassigned/scheduled badge pattern
  - Dovelite: app/admin/layout.tsx — role-protected layout pattern with redirect
  - Dovelite: components/Button.tsx — btn/btn-primary/btn-secondary class conventions adapted
  - Myprogram: RLS_POLICY_MATRIX.md — tech assignment scope (visits only to assigned_user_id) confirmed as DB-enforced; UI mirrors same constraint
  - Myprogram: DOMAIN_MODEL.md — job/visit status transition maps, role access matrix used for permission helper design
- Adoption decisions:
  - Adopted Dovelite grouped-by-status layout for jobs/visits lists
  - Adopted Dovelite server-side DB query pattern in server components (not loopback HTTP fetch)
  - Client interactive components (transition buttons, notes form) call API routes directly from browser — consistent with Dovelite client-side mutation approach
  - Tech scope enforced via SQL JOIN on visits.assigned_user_id — not client-only — matching Myprogram's RLS approach
- Risks or follow-ups:
  - /app/jobs/new and /app/jobs/[id]/visits/new are stubs pending P2-T1 and P2-T2 merges
  - Playwright E2E specs ready but require running dev server + seeded DB (not run in current CI gate)
  - Assignment update UI (PATCH visits.assigned_user_id) shows info text; full UI needed in follow-on

---

- Timestamp (UTC): 2026-02-17T23:00:00Z
- Agent: agent-c (Claude Sonnet 4.5)
- Branch: agent-c/P3-T1-estimates-lifecycle
- Task ID: P3-T1 / #17
- Summary: Implemented Estimates CRUD and lifecycle (draft→sent→approved|declined|expired). Full stack: backend API routes, frontend list/detail/form, unit tests, integration tests (skipped without test DB), E2E smoke, and RLS-context transaction helper.
- Files changed:
  - apps/web/lib/estimates/db.ts (new — RLS withEstimateContext)
  - apps/web/lib/estimates/math.ts (new — pure calcTotals, lineItemTotal)
  - apps/web/app/api/v1/estimates/route.ts (new — GET list, POST create)
  - apps/web/app/api/v1/estimates/[id]/route.ts (new — GET, PATCH, DELETE)
  - apps/web/app/api/v1/estimates/[id]/transition/route.ts (new — POST transition)
  - apps/web/app/app/estimates/page.tsx (replaced placeholder with real list)
  - apps/web/app/app/estimates/new/page.tsx (new — create form)
  - apps/web/app/app/estimates/[id]/page.tsx (new — detail page)
  - apps/web/app/app/estimates/[id]/EstimateTransitionForm.tsx (new)
  - apps/web/app/app/estimates/[id]/EstimateInternalNotesForm.tsx (new)
  - apps/web/lib/estimates/__tests__/estimates.unit.test.ts (new — 23 tests)
  - apps/web/lib/estimates/__tests__/estimates.integration.test.ts (new — 16 tests, skipped without DB)
  - tests/e2e/estimates-smoke.spec.ts (new — 6 E2E tests)
  - docs/WORK_ASSIGNMENT.md (added P3-T1 claim)
- Commands run:
  - git checkout -b agent-c/P3-T1-estimates-lifecycle
  - pnpm lint ✓
  - pnpm typecheck ✓
  - pnpm build ✓
  - pnpm test ✓ (23 new unit tests pass; 16 integration tests skipped — no TEST_DATABASE_URL)
- Gate results: lint ✓ / typecheck ✓ / build ✓ / test ✓ (96 tests pass, 16 skipped)
- Source evidence:
  - Dovelite: workflow/UX patterns — status-grouped list, card-based detail, transition buttons
  - Dovelite: estimate form with dynamic line items, unit price/qty/total calculation
  - Myprogram: RLS pattern — set_config('app.current_*', value, true) per transaction
  - Myprogram: immutability discipline — app-layer checks before DB trigger enforcement
  - AI-FSM: db/migrations/004_workflow_invariants.sql — estimate DB triggers already in place
  - AI-FSM: packages/domain/src/index.ts — estimateTransitions map reused directly
  - AI-FSM: apps/web/lib/auth/permissions.ts — canCreateEstimates/canSendEstimates/canDeleteRecords reused
- Risks or follow-ups:
  - Integration tests need TEST_DATABASE_URL env var to run (CI setup)
  - Estimate→Invoice conversion (P3-T2, #18) is out of scope — OUT OF SCOPE field immutability enforced
  - /api/v1/clients and /api/v1/jobs GET endpoints used by new/estimate form — these are placeholders; form will show empty dropdowns until those routes are implemented

---

- Timestamp (UTC): 2026-02-17T23:30:00Z
- Agent: agent-c (Claude Sonnet 4.5)
- Branch: agent-c/P3-T2-estimate-to-invoice-conversion
- Task ID: P3-T2 / #18
- Summary: Implemented Estimate→Invoice conversion with idempotency guard, immutable snapshot copy, invoice lifecycle API, invoice list/detail UI, unit tests (28), integration tests (12, skipped without DB), and E2E smoke (5 tests).
- Files changed:
  - apps/web/lib/invoices/db.ts (new — withInvoiceContext RLS helper, generateInvoiceNumber)
  - apps/web/app/api/v1/estimates/[id]/convert/route.ts (new — POST idempotent convert endpoint)
  - apps/web/app/api/v1/invoices/route.ts (new — GET list with filters/pagination)
  - apps/web/app/api/v1/invoices/[id]/route.ts (new — GET detail with line_items, PATCH draft fields)
  - apps/web/app/api/v1/invoices/[id]/transition/route.ts (new — POST transition, DB trigger guard)
  - apps/web/app/app/estimates/[id]/EstimateConvertButton.tsx (new — client component, idempotent convert)
  - apps/web/app/app/estimates/[id]/page.tsx (updated — shows convert button when approved)
  - apps/web/app/app/invoices/page.tsx (replaced placeholder — real invoice list, status-grouped)
  - apps/web/app/app/invoices/[id]/page.tsx (new — detail with line items, summary, transition panel)
  - apps/web/app/app/invoices/[id]/InvoiceTransitionForm.tsx (new — client component)
  - apps/web/lib/invoices/__tests__/invoices.unit.test.ts (new — 28 tests)
  - apps/web/lib/invoices/__tests__/invoices.integration.test.ts (new — 12 tests, skipped without DB)
  - tests/e2e/invoice-convert-smoke.spec.ts (new — 5 E2E tests)
  - docs/WORK_ASSIGNMENT.md (P3-T2 claim → completed)
- Commands run:
  - git checkout -b agent-c/P3-T2-estimate-to-invoice-conversion
  - pnpm lint ✓
  - pnpm build ✓ (regenerates .next/types/link.d.ts for new /app/invoices/[id] route)
  - pnpm typecheck ✓
  - pnpm test ✓ (124 tests pass, 28 skipped)
- Gate results: lint ✓ / typecheck ✓ / build ✓ / test ✓ (124 pass, 28 skipped — integration requires DB)
- Idempotency proof: POST /api/v1/estimates/:id/convert checks SELECT FROM invoices WHERE estimate_id = $1; returns existing invoice_id with created=false (HTTP 200) if already converted; inserts new with created=true (HTTP 201) otherwise.
- Source evidence:
  - AI-FSM: db/migrations/001_core_schema.sql — invoices.estimate_id FK, invoice_line_items.estimate_line_item_id FK
  - AI-FSM: packages/domain/src/index.ts — invoiceTransitions map (draft allows sent+void; paid/void terminal)
  - Myprogram: immutability discipline — snapshot at conversion; invoice line items never mutated after creation
  - AI-FSM: apps/web/lib/estimates/db.ts — withEstimateContext pattern replicated as withInvoiceContext
- Risks or follow-ups:
  - Integration tests need TEST_DATABASE_URL env var (CI setup)
  - Invoice number generation (COUNT-based) is eventually-consistent under high concurrency — acceptable for P3 scope
  - Payment recording (P3-T3) will update invoice paid_cents via payment trigger already in 004_workflow_invariants.sql

---

- Timestamp (UTC): 2026-02-18T00:00:00Z
- Agent: agent-c (Claude Opus 4.6)
- Branch: agent-c/P3-T3-manual-payment-status-sync
- Task ID: P3-T3 / #19
- Summary: Implemented manual payment recording with invoice status sync. Full stack: payment POST/GET/DELETE API endpoints with Zod validation, idempotency key support, deterministic duplicate guard (60s window), audit logging for both payment creation and invoice status changes. Frontend: record payment form with dollar-to-cents conversion, payment history table with live reload, payment form only shown on payable invoices (sent/partial/overdue) for owner/admin. Added 22 unit tests for payment math/status derivation/validation, 13 integration test stubs (12 skipped without DB), 5 E2E smoke tests. Added missing CSS classes for invoice/estimate status pills, line-items table, and payment form.
- Files changed:
  - apps/web/lib/invoices/payments.ts (new — deriveInvoiceStatus, amountDueCents, validatePaymentAmount)
  - apps/web/app/api/v1/invoices/[id]/payments/route.ts (new — GET list + POST record with idempotency)
  - apps/web/app/api/v1/payments/[id]/route.ts (new — DELETE owner-only with recalculation)
  - apps/web/app/app/invoices/[id]/RecordPaymentForm.tsx (new — client component, dollar input, method select)
  - apps/web/app/app/invoices/[id]/PaymentHistory.tsx (new — client component, fetches + displays payment list)
  - apps/web/app/app/invoices/[id]/page.tsx (updated — added RecordPaymentForm + PaymentHistory sections)
  - apps/web/app/globals.css (updated — added status-pill variants for sent/partial/paid/overdue/void/approved/declined/expired, line-items-table, payment-form-fields, payment-select)
  - apps/web/lib/invoices/__tests__/payments.unit.test.ts (new — 22 tests)
  - apps/web/lib/invoices/__tests__/payments.integration.test.ts (new — 13 tests, 12 skipped without DB)
  - tests/e2e/payment-smoke.spec.ts (new — 5 E2E tests)
  - docs/WORK_ASSIGNMENT.md (P3-T3 claim registered)
- Commands run:
  - git checkout -b agent-c/P3-T3-manual-payment-status-sync
  - pnpm lint ✓
  - pnpm typecheck ✓
  - pnpm build ✓
  - pnpm test ✓ (147 tests pass, 40 skipped — integration requires DB)
- Gate results: lint ✓ / typecheck ✓ / build ✓ / test ✓ (147 pass, 40 skipped)
- Payment status sync proof:
  - DB trigger `trg_payment_sync_invoice` (004_workflow_invariants.sql) fires AFTER INSERT on payments
  - Trigger sums all payments, derives status (partial if paid < total, paid if paid >= total)
  - API POST endpoint validates payable status (sent/partial/overdue), validates amount <= remaining, inserts payment, reads back updated invoice status
  - API DELETE endpoint recalculates paid_cents from remaining payments, derives new status
  - Duplicate protection: deterministic guard (same invoice+amount+method within 60s = CONFLICT); optional idempotency_key prefix in notes field
- Source evidence:
  - AI-FSM: db/migrations/004_workflow_invariants.sql — sync_invoice_on_payment trigger (SECURITY DEFINER, FOR UPDATE lock)
  - AI-FSM: db/migrations/003_rls_policies.sql — payments_select (all roles), payments_insert (owner/admin), payments_delete (owner only)
  - AI-FSM: packages/domain/src/index.ts — paymentMethodSchema, paymentSchema, invoiceTransitions map
  - AI-FSM: apps/web/lib/invoices/db.ts — withInvoiceContext RLS pattern reused
  - AI-FSM: apps/web/lib/auth/permissions.ts — canRecordPayments reused
  - Myprogram: RLS_POLICY_MATRIX.md — owner/admin write pattern for financial entities
  - Dovelite: components/InvoiceDetail — payment history display pattern reference
- Risks or follow-ups:
  - Integration tests need TEST_DATABASE_URL env var to run (CI setup)
  - Idempotency key stored as notes prefix `[idem:key]` — lightweight, no schema change
  - DELETE /payments/:id recalculates manually (trigger only fires on INSERT) — verified correct in unit tests
  - E2E tests require seeded invoices in 'sent' status

## [P4-T1] Visit Reminder Automation Worker + CI DB Integration — agent-d — 2026-02-17
- Issue: #20
- Branch: agent-d/P4-T1-visit-reminder-worker-ci-db
- Summary: Implemented visit reminder automation worker and hardened CI with PostgreSQL service for DB integration tests.

### Scope A: Visit Reminder Automation
- New file: services/worker/src/visit-reminder.ts
  - `findDueReminders()` — queries automations WHERE type='visit_reminder', enabled, next_run_at <= now()
  - `findEligibleVisits()` — finds visits within `hours_before` window, status='scheduled', NOT EXISTS in audit_log (idempotency)
  - `emitVisitReminder()` — double-check idempotency + INSERT into audit_log (entity_type='visit_reminder')
  - `markAutomationRun()` — updates last_run_at, advances next_run_at by 1 hour
  - `processVisitReminder()` — processes each visit independently (errors don't block others)
  - `runVisitReminders()` — top-level orchestrator for all due automations
- Updated: services/worker/src/index.ts — dispatches visit reminders in poll loop

### Scope B: CI DB Integration Tests
- Updated: .github/workflows/ci.yml
  - Added PostgreSQL 16 service container (user: test, db: aifsm_test)
  - Added migration step (applies all *.sql except seed, then seed separately)
  - Sets TEST_DATABASE_URL for DB-only integration tests
  - TEST_BASE_URL intentionally NOT set — HTTP integration tests skip gracefully
- Updated: apps/web/lib/estimates/__tests__/estimates.integration.test.ts — skip requires both TEST_DATABASE_URL AND TEST_BASE_URL
- Updated: apps/web/lib/invoices/__tests__/invoices.integration.test.ts — same skip condition fix

### Tests
- services/worker/src/visit-reminder.test.ts — 16 unit tests (all mock-based, pass without DB)
- services/worker/src/visit-reminder.integration.test.ts — 9 integration tests (8 skip without DB, 1 always runs)
- tests/e2e/visit-reminder-smoke.spec.ts — 2 E2E smoke tests (Playwright)
- Files modified:
  - services/worker/src/visit-reminder.ts (new)
  - services/worker/src/visit-reminder.test.ts (new)
  - services/worker/src/visit-reminder.integration.test.ts (new)
  - services/worker/src/index.ts (modified)
  - .github/workflows/ci.yml (modified)
  - apps/web/lib/estimates/__tests__/estimates.integration.test.ts (modified)
  - apps/web/lib/invoices/__tests__/invoices.integration.test.ts (modified)
  - tests/e2e/visit-reminder-smoke.spec.ts (new)
  - docs/WORK_ASSIGNMENT.md (modified)
- Commands run:
  - git checkout -b agent-d/P4-T1-visit-reminder-worker-ci-db
  - pnpm lint ✓
  - pnpm typecheck ✓
  - pnpm build ✓
  - pnpm test ✓ (168 tests pass, 48 skipped — integration requires DB/server)
- Gate results: lint ✓ / typecheck ✓ / build ✓ / test ✓ (168 pass, 48 skipped)
- Idempotency proof:
  - `findEligibleVisits` uses NOT EXISTS subquery against audit_log to skip already-reminded visits
  - `emitVisitReminder` double-checks with SELECT before INSERT (race condition guard)
  - Unit test "returns false and skips insert if reminder already exists" verifies idempotency
  - Integration test "repeated runs don't duplicate reminders" verifies end-to-end idempotency
- Retry-safety proof:
  - Each visit processed independently in try/catch — one failure doesn't block others
  - Each automation processed independently — one failure doesn't block others
  - Unit tests verify: "continues processing after individual visit errors", "continues after a failed automation"
  - `markAutomationRun` always called (even with 0 eligible visits) to advance next_run_at
- CI evidence:
  - PostgreSQL 16 service container with health checks
  - Migrations applied via psql loop (skipping seed, then applying seed separately)
  - TEST_DATABASE_URL set for worker integration tests
  - HTTP-based integration tests (estimates, invoices) require TEST_BASE_URL to run — gracefully skip in CI
- Source evidence:
  - AI-FSM: docs/contracts/workflow-states.md — Automation Types table (visit_reminder)
  - AI-FSM: db/migrations/001_core_schema.sql — automations.config jsonb, audit_log table
  - Myprogram: EDGE_FUNCTIONS_RUNBOOK.md — idempotent worker pattern reference
  - Dovelite: scripts/preflight.mjs — safe retry/check-before-act pattern reference
- Risks or follow-ups:
  - Worker integration tests need real PostgreSQL (skipped without TEST_DATABASE_URL)
  - E2E tests need running dev server + seeded data
  - `hours_before` defaults to 24 if not set in automation config
  - next_run_at advances by 1 hour — high-frequency polling for near-real-time reminders
