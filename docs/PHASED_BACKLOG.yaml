meta:
  project: ai-fsm
  mode: autonomous
  quality_gate: pnpm gate

epics:
  - id: E0
    name: Planning and Contract Freeze
    phase: 0
    tasks:
      - id: P0-T1
        title: Freeze domain model and workflow statuses
        status: completed
        completed_by: agent-orchestrator
        acceptance:
          - domain-model.md frozen with all entity specs
          - workflow-states.md frozen with transition tables
          - Zod schemas match frozen contract
          - Migration matches frozen contract
      - id: P0-T2
        title: Freeze API contracts and error model
        status: completed
        completed_by: agent-orchestrator
        acceptance:
          - api-contract.md frozen with all endpoints and error model
      - id: P0-T3
        title: Freeze test strategy and quality thresholds
        status: completed
        completed_by: agent-orchestrator
        acceptance:
          - test-strategy.md frozen with tooling, categories, and phase rollout

  - id: E1
    name: Foundation
    phase: 1
    tasks:
      - id: T1-1
        title: Implement email/password auth and session handling
        status: completed
        completed_by: agent-a
        acceptance:
          - owner/admin/tech can sign in
          - unauthorized routes redirect to login
      - id: T1-2
        title: Implement jobs CRUD with status transitions
        status: completed
        completed_by: agent-orchestrator
        acceptance:
          - create/read/update jobs
          - status transitions validated
      - id: T1-3
        title: Implement visits scheduling and assignment
        status: completed
        completed_by: agent-orchestrator
        acceptance:
          - assign tech to visit
          - complete visit with notes

  - id: E2
    name: Commercial Flow
    phase: 2
    tasks:
      - id: T2-1
        title: Implement estimates CRUD and lifecycle
        status: completed
        completed_by: agent-orchestrator
        acceptance:
          - estimate statuses enforced
      - id: T2-2
        title: Implement estimate-to-invoice conversion
        status: completed
        completed_by: agent-orchestrator
        acceptance:
          - conversion creates immutable snapshot line items
      - id: T2-3
        title: Implement manual payment recording
        status: completed
        completed_by: agent-orchestrator
        acceptance:
          - invoice paid/partial updates automatically

  - id: E3
    name: Automations + Hardening
    phase: 3
    tasks:
      - id: T3-1
        title: Add visit reminder automation
        status: completed
        completed_by: agent-orchestrator
        acceptance:
          - reminders generated before scheduled visits
      - id: T3-2
        title: Add overdue invoice follow-up automation
        status: completed
        completed_by: agent-orchestrator
        acceptance:
          - follow-up events generated by aging rule
      - id: T3-3
        title: Pi deployment and backup runbook
        status: completed
        completed_by: agent-orchestrator
        acceptance:
          - deploy on arm64 compose profile
          - backup/restore validated

  - id: E5
    name: Production Readiness Hardening
    phase: 5
    tasks:
      - id: P5-T1
        title: Security hardening
        status: completed
        completed_by: agent-orchestrator
        acceptance:
          - Rate limiting on login and sensitive endpoints
          - Secure cookie flags audited and enforced
          - Env validation fail-fast with min AUTH_SECRET length
          - Security response headers (CSP, X-Frame-Options, etc.)
          - Password complexity validation
          - ADR documenting security posture
          - Tests for rate limiter and security headers
      - id: P5-T2
        title: Branch/CI governance
        status: completed
        completed_by: agent-orchestrator
        acceptance:
          - Branch protection restored (approvals, status checks, up-to-date)
          - CI deterministic with no flaky suites
      - id: P5-T3
        title: Observability and recovery
        status: completed
        completed_by: agent-orchestrator
        acceptance:
          - Structured logging for web and worker
          - Request/job correlation IDs end-to-end
          - Health/readiness checks with DB connectivity
          - Backup/restore runbook with validation drill
      - id: P5-T4
        title: Test matrix completion
        status: completed
        completed_by: agent-orchestrator
        acceptance:
          - Unit/integration/HTTP/E2E suites separated
          - Intentional skips documented
          - No accidental coverage gaps
      - id: P5-T5
        title: UX stabilization
        status: completed
        completed_by: agent-orchestrator
        acceptance:
          - Error states, empty states, loading states for all flows
          - Form validation messages
          - Destructive action confirmations
      - id: P5-T6
        title: Release readiness docs
        status: completed
        completed_by: agent-orchestrator
        acceptance:
          - PROD_READINESS_CHECKLIST.md
          - DEPLOYMENT_RUNBOOK.md
          - INCIDENT_RESPONSE.md
          - Pi4 constraints documented

  - id: E6
    name: Frontend Productization
    phase: 6
    tasks:
      - id: P6-T1A
        title: Global shell + navigation coherence
        status: completed
        completed_by: agent-orchestrator
        acceptance:
          - Active nav state indicator on all pages
          - App branding/logo in header
          - Mobile-responsive navigation
          - Dashboard or redirect option from root
      - id: P6-T1B
        title: Jobs workspace polish
        status: completed
        completed_by: agent-orchestrator
        acceptance:
          - Priority badge on job cards
          - Search/filter capability
          - Improved empty states with CTAs
      - id: P6-T1C
        title: Visits workspace polish
        status: completed
        completed_by: agent-orchestrator
        acceptance:
          - My Day view for tech role
          - Overdue visit highlighting
          - Quick assignment modal for admin
      - id: P6-T1D
        title: Estimates/Invoices workspace polish
        status: completed
        completed_by: agent-orchestrator
        acceptance:
          - Outstanding totals summary
          - Conversion funnel visibility
          - Invoice aging indicators

      - id: P6-T2A
        title: Jobs create UX
        status: completed
        completed_by: agent-orchestrator
        acceptance:
          - Real create form with title/client/property/description/priority
          - Client-side validation + inline errors
          - Success redirect to job detail
      - id: P6-T2B
        title: Visit schedule UX
        status: completed
        completed_by: agent-orchestrator
        acceptance:
          - Real scheduling form with start/end/assignment
          - Role-aware assignment field
          - Success redirect to visit detail
      - id: P6-T2C
        title: E2E core flow
        status: completed
        completed_by: agent-orchestrator
        acceptance:
          - Playwright spec for admin login -> job -> visit -> estimate -> invoice -> payment
          - Deterministic test data strategy
      - id: P6-T2D
        title: Tracking + docs update
        status: completed
        completed_by: agent-orchestrator
        acceptance:
          - PHASED_BACKLOG.yaml updated
          - WORK_ASSIGNMENT.md updated
          - CHANGELOG_AI.md updated

      - id: P6-T3
        title: Operations UX Completion + Doc/Governance Reconciliation
        status: completed
        completed_by: agent-orchestrator
        acceptance:
          - Automations page with Visit Reminders, Overdue Invoice Follow-ups, Recent Events sections
          - Stats for last 24h and 7d sent/skipped/errors
          - Manual "Run now" actions for admin/owner (POST endpoints with RBAC)
          - Tech role: read-only limited view; no run controls
          - API tests for automations endpoints (RBAC + idempotency)
          - E2E smoke for automations page visibility and run button
          - PHASED_BACKLOG.yaml and WORK_ASSIGNMENT.md reconciled to reality
