meta:
  project: ai-fsm
  mode: autonomous
  quality_gate: pnpm gate

epics:
  - id: E0
    name: Planning and Contract Freeze
    phase: 0
    tasks:
      - id: P0-T1
        title: Freeze domain model and workflow statuses
        status: completed
        completed_by: agent-orchestrator
        acceptance:
          - domain-model.md frozen with all entity specs
          - workflow-states.md frozen with transition tables
          - Zod schemas match frozen contract
          - Migration matches frozen contract
      - id: P0-T2
        title: Freeze API contracts and error model
        status: completed
        completed_by: agent-orchestrator
        acceptance:
          - api-contract.md frozen with all endpoints and error model
      - id: P0-T3
        title: Freeze test strategy and quality thresholds
        status: completed
        completed_by: agent-orchestrator
        acceptance:
          - test-strategy.md frozen with tooling, categories, and phase rollout

  - id: E1
    name: Foundation
    phase: 1
    tasks:
      - id: T1-1
        title: Implement email/password auth and session handling
        status: completed
        completed_by: agent-a
        acceptance:
          - owner/admin/tech can sign in
          - unauthorized routes redirect to login
      - id: T1-2
        title: Implement jobs CRUD with status transitions
        status: in_progress
        completed_by: agent-orchestrator
        acceptance:
          - create/read/update jobs
          - status transitions validated
      - id: T1-3
        title: Implement visits scheduling and assignment
        status: pending
        acceptance:
          - assign tech to visit
          - complete visit with notes

  - id: E2
    name: Commercial Flow
    phase: 2
    tasks:
      - id: T2-1
        title: Implement estimates CRUD and lifecycle
        status: completed
        acceptance:
          - estimate statuses enforced
      - id: T2-2
        title: Implement estimate-to-invoice conversion
        status: completed
        acceptance:
          - conversion creates immutable snapshot line items
      - id: T2-3
        title: Implement manual payment recording
        status: pending
        acceptance:
          - invoice paid/partial updates automatically

  - id: E3
    name: Automations + Hardening
    phase: 3
    tasks:
      - id: T3-1
        title: Add visit reminder automation
        status: pending
        acceptance:
          - reminders generated before scheduled visits
      - id: T3-2
        title: Add overdue invoice follow-up automation
        status: pending
        acceptance:
          - follow-up events generated by aging rule
      - id: T3-3
        title: Pi deployment and backup runbook
        status: pending
        acceptance:
          - deploy on arm64 compose profile
          - backup/restore validated

  - id: E5
    name: Production Readiness Hardening
    phase: 5
    tasks:
      - id: P5-T1
        title: Security hardening
        status: completed
        completed_by: agent-orchestrator
        acceptance:
          - Rate limiting on login and sensitive endpoints
          - Secure cookie flags audited and enforced
          - Env validation fail-fast with min AUTH_SECRET length
          - Security response headers (CSP, X-Frame-Options, etc.)
          - Password complexity validation
          - ADR documenting security posture
          - Tests for rate limiter and security headers
      - id: P5-T2
        title: Branch/CI governance
        status: completed
        completed_by: agent-orchestrator
        acceptance:
          - Branch protection restored (approvals, status checks, up-to-date)
          - CI deterministic with no flaky suites
      - id: P5-T3
        title: Observability and recovery
        status: pending
        acceptance:
          - Structured logging for web and worker
          - Request/job correlation IDs end-to-end
          - Health/readiness checks with DB connectivity
          - Backup/restore runbook with validation drill
      - id: P5-T4
        title: Test matrix completion
        status: completed
        completed_by: agent-orchestrator
        acceptance:
          - Unit/integration/HTTP/E2E suites separated
          - Intentional skips documented
          - No accidental coverage gaps
      - id: P5-T5
        title: UX stabilization
        status: completed
        completed_by: agent-orchestrator
        acceptance:
          - Error states, empty states, loading states for all flows
          - Form validation messages
          - Destructive action confirmations
      - id: P5-T6
        title: Release readiness docs
        status: pending
        acceptance:
          - PROD_READINESS_CHECKLIST.md
          - DEPLOYMENT_RUNBOOK.md
          - INCIDENT_RESPONSE.md
          - Pi4 constraints documented
